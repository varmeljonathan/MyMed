<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set New Password - myMed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .success-container {
            text-align: center;
            padding: 30px 20px;
            display: none;
        }
        
        .success-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 20px;
        }
        
        .error-container {
            text-align: center;
            padding: 30px 20px;
            display: none;
        }
        
        .error-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 20px;
        }
        
        .password-strength-meter {
            margin-top: 5px;
            height: 5px;
            background-color: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .password-strength-value {
            height: 100%;
            width: 0;
            border-radius: 3px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        
        .password-strength-text {
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        .strength-weak {
            background-color: #ef4444;
            width: 33%;
        }
        
        .strength-medium {
            background-color: #f59e0b;
            width: 66%;
        }
        
        .strength-strong {
            background-color: #10b981;
            width: 100%;
        }
        
        @media (prefers-color-scheme: dark) {
            .password-strength-meter {
                background-color: #333;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="primary-header">
            <h1>Set New Password</h1>
        </div>

        <div class="card">
            <div class="card-body">
                <div id="new-password-form-container">
                    <p class="mb-4">Create a new password for your account.</p>
                    
                    <form id="new-password-form">
                        <div class="form-group">
                            <label for="new-password" class="form-label">New Password</label>
                            <input type="password" id="new-password" class="form-control" required>
                            <div class="password-strength-meter">
                                <div class="password-strength-value" id="password-strength-meter"></div>
                            </div>
                            <div class="password-strength-text" id="password-strength-text">Password strength: Enter a password</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm-password" class="form-label">Confirm Password</label>
                            <input type="password" id="confirm-password" class="form-control" required>
                        </div>
                        
                        <input type="hidden" id="reset-token" value="">
                        
                        <button type="submit" class="btn btn-primary btn-block">Set New Password</button>
                    </form>
                </div>
                
                <div id="password-reset-success" class="success-container">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    
                    <h2>Password Updated</h2>
                    <p class="success-message">Your password has been successfully updated. You can now login with your new password.</p>
                    
                    <a href="login.html" class="btn btn-primary">Go to Login</a>
                </div>
                
                <div id="password-reset-error" class="error-container">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    
                    <h2>Invalid or Expired Link</h2>
                    <p class="error-message">This password reset link is invalid or has expired. Please request a new password reset link.</p>
                    
                    <a href="forgot_password.html" class="btn btn-primary">Request New Link</a>
                </div>
            </div>
        </div>
    </div>
    
    <script src="js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Extract token from URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                showInvalidTokenError();
                return;
            }
            
            // Check if token is valid
            const passwordResets = Storage.get('myMed_password_resets') || {};
            const resetInfo = passwordResets[token];
            
            if (!resetInfo) {
                showInvalidTokenError();
                return;
            }
            
            // Check if token is expired
            const now = new Date();
            const expires = new Date(resetInfo.expires);
            
            if (now > expires) {
                showInvalidTokenError('This reset link has expired. Please request a new one.');
                return;
            }
            
            // Set the token value in the hidden input
            document.getElementById('reset-token').value = token;
            
            // Setup password strength meter
            const newPasswordInput = document.getElementById('new-password');
            const strengthMeter = document.getElementById('password-strength-meter');
            const strengthText = document.getElementById('password-strength-text');
            
            newPasswordInput.addEventListener('input', function() {
                const password = this.value;
                const strength = calculatePasswordStrength(password);
                
                // Update meter
                strengthMeter.className = 'password-strength-value';
                
                if (password.length === 0) {
                    strengthMeter.style.width = '0';
                    strengthText.textContent = 'Password strength: Enter a password';
                } else if (strength < 33) {
                    strengthMeter.classList.add('strength-weak');
                    strengthText.textContent = 'Password strength: Weak';
                } else if (strength < 66) {
                    strengthMeter.classList.add('strength-medium');
                    strengthText.textContent = 'Password strength: Medium';
                } else {
                    strengthMeter.classList.add('strength-strong');
                    strengthText.textContent = 'Password strength: Strong';
                }
            });
            
            // Handle form submission
            const newPasswordForm = document.getElementById('new-password-form');
            
            newPasswordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const resetToken = document.getElementById('reset-token').value;
                
                // Validate passwords
                if (newPassword.length < 6) {
                    UIHelper.showToast('Password must be at least 6 characters long', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    UIHelper.showToast('Passwords do not match', 'error');
                    return;
                }
                
                // Get reset info
                const passwordResets = Storage.get('myMed_password_resets') || {};
                const resetInfo = passwordResets[resetToken];
                
                if (!resetInfo) {
                    showInvalidTokenError();
                    return;
                }
                
                // Update user's password
                const users = Storage.get('myMed_users') || [];
                const userIndex = users.findIndex(user => user.email === resetInfo.email);
                
                if (userIndex === -1) {
                    showInvalidTokenError('User not found');
                    return;
                }
                
                // Update password
                users[userIndex].password = newPassword;
                Storage.save('myMed_users', users);
                
                // Remove the used token
                delete passwordResets[resetToken];
                Storage.save('myMed_password_resets', passwordResets);
                
                // Show success message
                document.getElementById('new-password-form-container').style.display = 'none';
                document.getElementById('password-reset-success').style.display = 'block';
            });
            
            // Function to show invalid token error
            function showInvalidTokenError(message) {
                document.getElementById('new-password-form-container').style.display = 'none';
                
                if (message) {
                    document.querySelector('.error-message').textContent = message;
                }
                
                document.getElementById('password-reset-error').style.display = 'block';
            }
            
            // Function to calculate password strength
            function calculatePasswordStrength(password) {
                let strength = 0;
                
                // Length contribution (up to 40%)
                const lengthFactor = Math.min(password.length / 10, 1);
                strength += lengthFactor * 40;
                
                // Character variety contribution (up to 60%)
                const hasLower = /[a-z]/.test(password);
                const hasUpper = /[A-Z]/.test(password);
                const hasNumber = /[0-9]/.test(password);
                const hasSpecial = /[^a-zA-Z0-9]/.test(password);
                
                const varietyCount = [hasLower, hasUpper, hasNumber, hasSpecial].filter(Boolean).length;
                strength += (varietyCount / 4) * 60;
                
                return strength;
            }
        });
    </script>
</body>
</html>